<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - GameZone</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        :root {
            --primary: #2c3e50;
            --secondary: #3498db;
            --accent: #e74c3c;
            --light: #ecf0f1;
            --dark: #2c3e50;
            --success: #2ecc71;
            --warning: #f39c12;
            --gray: #95a5a6;
        }

        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }

        .container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* Header Styles */
        header {
            background-color: var(--primary);
            color: white;
            padding: 15px 0;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.8rem;
            font-weight: 700;
        }

        .logo i {
            color: var(--secondary);
        }

        .header-actions {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .currency-selector {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 0.9rem;
        }

        .btn {
            padding: 8px 16px;
            border-radius: 4px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            border: none;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .btn-primary {
            background-color: var(--secondary);
            color: white;
        }

        .btn-primary:hover {
            background-color: #2980b9;
        }

        .btn-outline {
            background-color: transparent;
            color: white;
            border: 1px solid white;
        }

        .btn-outline:hover {
            background-color: white;
            color: var(--primary);
        }

        .btn-danger {
            background-color: var(--accent);
            color: white;
        }

        .btn-danger:hover {
            background-color: #c0392b;
        }

        .btn-success {
            background-color: var(--success);
            color: white;
        }

        .btn-success:hover {
            background-color: #27ae60;
        }

        .btn-warning {
            background-color: var(--warning);
            color: white;
        }

        .btn-warning:hover {
            background-color: #e67e22;
        }

        /* Admin Panel */
        .admin-panel {
            padding: 30px 0;
        }

        .admin-header {
            background: var(--primary);
            color: white;
            padding: 15px 0;
            margin-bottom: 30px;
        }

        .admin-nav {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            border-bottom: 1px solid #ddd;
        }

        .admin-nav button {
            background: none;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            font-size: 1rem;
            color: var(--dark);
            border-bottom: 3px solid transparent;
        }

        .admin-nav button.active {
            color: var(--secondary);
            border-bottom: 3px solid var(--secondary);
        }

        .admin-section {
            display: none;
        }

        .admin-section.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .form-control {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .table th, .table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        .table th {
            background-color: #f8f9fa;
            font-weight: 600;
        }

        .table tr:hover {
            background-color: #f8f9fa;
        }

        /* Login Form */
        .login-container {
            max-width: 400px;
            margin: 100px auto;
            padding: 30px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .login-title {
            text-align: center;
            margin-bottom: 30px;
            color: var(--primary);
        }

        .alert {
            padding: 12px 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }

        .alert-danger {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        /* Footer */
        footer {
            background: var(--dark);
            color: white;
            padding: 30px 0 15px;
            margin-top: 50px;
        }

        .copyright {
            text-align: center;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 0.9rem;
            color: #aaa;
        }

        .powered-by {
            text-align: center;
            margin-top: 10px;
            font-size: 0.8rem;
            color: #ddd;
        }

        /* Settings Section */
        .settings-group {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .settings-group h3 {
            margin-bottom: 15px;
            color: var(--primary);
        }

        /* Image Upload Styles */
        .image-upload-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .image-upload-box {
            border: 2px dashed #ddd;
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: #f8f9fa;
        }

        .image-upload-box:hover {
            border-color: var(--secondary);
            background-color: #e3f2fd;
        }

        .image-upload-box i {
            font-size: 3rem;
            color: var(--gray);
            margin-bottom: 10px;
        }

        .image-upload-box p {
            margin-bottom: 10px;
            color: var(--gray);
        }

        .image-preview {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 15px;
        }

        .image-preview-item {
            position: relative;
            width: 120px;
            height: 120px;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            border: 2px solid #ddd;
        }

        .image-preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .image-preview-item .remove-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(255,255,255,0.9);
            border: none;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 0.8rem;
            color: var(--accent);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .upload-options {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .upload-progress {
            width: 100%;
            height: 20px;
            background: #f0f0f0;
            border-radius: 10px;
            margin-top: 10px;
            overflow: hidden;
            display: none;
        }

        .upload-progress-bar {
            height: 100%;
            background: var(--success);
            width: 0%;
            transition: width 0.3s;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 15px;
            }

            .admin-nav {
                flex-wrap: wrap;
            }
            
            .header-actions {
                flex-direction: column;
                width: 100%;
            }
            
            .currency-selector {
                width: 100%;
                margin-bottom: 10px;
            }
            
            .image-preview {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <!-- Login Form (shown by default) -->
    <div id="loginForm" class="login-container">
        <h2 class="login-title">Admin Login</h2>
        <div id="loginError" class="alert alert-danger" style="display: none;">
            Invalid email or password!
        </div>
        <div class="form-group">
            <label for="email">Email</label>
            <input type="email" id="email" class="form-control" placeholder="Enter your email">
        </div>
        <div class="form-group">
            <label for="password">Password</label>
            <input type="password" id="password" class="form-control" placeholder="Enter your password">
        </div>
        <button class="btn btn-primary btn-block" onclick="login()">
            <i class="fas fa-sign-in-alt"></i> Login
        </button>
        <div style="text-align: center; margin-top: 20px;">
            <a href="index.html" class="btn btn-outline">
                <i class="fas fa-arrow-left"></i> Back to Store
            </a>
        </div>
    </div>

    <!-- Admin Panel (hidden by default) -->
    <div id="adminPanel" style="display: none;">
        <!-- Header -->
        <header>
            <div class="container">
                <div class="header-content">
                    <div class="logo">
                        <i class="fas fa-user-shield"></i>
                        <span>GameZone Admin</span>
                    </div>
                    <div class="header-actions">
                        <select id="currencySelect" class="currency-selector" onchange="updateCurrency(this.value)">
                            <option value="USD">USD ($)</option>
                            <option value="EUR">EUR (€)</option>
                            <option value="GBP">GBP (£)</option>
                            <option value="INR">INR (₹)</option>
                            <option value="JPY">JPY (¥)</option>
                        </select>
                        <button class="btn btn-outline" onclick="logout()">
                            <i class="fas fa-sign-out-alt"></i> Logout
                        </button>
                        <a href="index.html" class="btn btn-outline">
                            <i class="fas fa-store"></i> View Store
                        </a>
                    </div>
                </div>
            </div>
        </header>

        <!-- Admin Navigation -->
        <div class="admin-header">
            <div class="container">
                <h1>Admin Dashboard</h1>
            </div>
        </div>

        <div class="container admin-panel">
            <div class="admin-nav">
                <button class="active" onclick="showSection('products')">
                    <i class="fas fa-boxes"></i> Products
                </button>
                <button onclick="showSection('orders')">
                    <i class="fas fa-shopping-cart"></i> Orders
                </button>
                <button onclick="showSection('addProduct')">
                    <i class="fas fa-plus-circle"></i> Add Product
                </button>
                <button onclick="showSection('settings')">
                    <i class="fas fa-cog"></i> Settings
                </button>
            </div>

            <!-- Products Section -->
            <div id="productsSection" class="admin-section active">
                <h2>Product Management</h2>
                <table class="table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Image</th>
                            <th>Name</th>
                            <th>Price</th>
                            <th>Product URL</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="productsTable">
                        <!-- Products will be loaded here -->
                    </tbody>
                </table>
            </div>

            <!-- Orders Section -->
            <div id="ordersSection" class="admin-section">
                <h2>Order Management</h2>
                <table class="table">
                    <thead>
                        <tr>
                            <th>Order ID</th>
                            <th>Date</th>
                            <th>Items</th>
                            <th>Total</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="ordersTable">
                        <!-- Orders will be loaded here -->
                    </tbody>
                </table>
            </div>

            <!-- Add Product Section -->
            <div id="addProductSection" class="admin-section">
                <h2>Add New Product</h2>
                <form id="addProductForm">
                    <div class="form-group">
                        <label for="productName">Product Name</label>
                        <input type="text" id="productName" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="productDescription">Description</label>
                        <textarea id="productDescription" class="form-control" rows="3" required></textarea>
                    </div>
                    <div class="form-group">
                        <label for="productPrice">Price (USD)</label>
                        <input type="number" id="productPrice" class="form-control" step="0.01" min="0" required>
                    </div>
                    
                    <!-- Image Upload Section -->
                    <div class="form-group">
                        <label>Product Image</label>
                        <div class="image-upload-container">
                            <div class="upload-options">
                                <button type="button" class="btn btn-outline" onclick="showImageUrlInput()">
                                    <i class="fas fa-link"></i> Use Image URL
                                </button>
                                <button type="button" class="btn btn-outline" onclick="showImageUploadBox()">
                                    <i class="fas fa-upload"></i> Upload Image
                                </button>
                            </div>
                            
                            <!-- Image URL Input -->
                            <div id="imageUrlInput" class="form-group">
                                <input type="url" id="productImage" class="form-control" placeholder="https://example.com/image.jpg">
                            </div>
                            
                            <!-- Image Upload Box -->
                            <div id="imageUploadBox" class="image-upload-box" style="display: none;">
                                <i class="fas fa-cloud-upload-alt"></i>
                                <p>Drag & drop an image here or click to browse</p>
                                <input type="file" id="imageFileInput" accept="image/*" style="display: none;">
                                <button type="button" class="btn btn-primary" onclick="document.getElementById('imageFileInput').click()">
                                    <i class="fas fa-folder-open"></i> Browse Files
                                </button>
                                <div class="upload-progress" id="uploadProgress">
                                    <div class="upload-progress-bar" id="uploadProgressBar"></div>
                                </div>
                            </div>
                            
                            <!-- Image Preview -->
                            <div id="imagePreview" class="image-preview"></div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="productCategory">Category</label>
                        <input type="text" id="productCategory" class="form-control" value="Gaming Accessories">
                    </div>
                    <div class="form-group">
                        <label for="productFeatures">Features (comma separated)</label>
                        <input type="text" id="productFeatures" class="form-control" placeholder="High Quality, Durable, Premium Build">
                    </div>
                    <div class="form-group">
                        <label for="productUrl">Product Page URL (Where users will be redirected when clicking Buy)</label>
                        <input type="url" id="productUrl" class="form-control" placeholder="https://example.com/product-page" required>
                        <small style="color: #666; font-size: 12px;">This is the external link where customers will be redirected when they click the Buy button</small>
                    </div>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-plus"></i> Add Product
                    </button>
                </form>
            </div>

            <!-- Edit Product Modal -->
            <div id="editProductModal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
                <div class="modal-content" style="background: white; padding: 30px; border-radius: 8px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto;">
                    <h2>Edit Product</h2>
                    <form id="editProductForm">
                        <input type="hidden" id="editProductId">
                        <div class="form-group">
                            <label for="editProductName">Product Name</label>
                            <input type="text" id="editProductName" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="editProductDescription">Description</label>
                            <textarea id="editProductDescription" class="form-control" rows="3" required></textarea>
                        </div>
                        <div class="form-group">
                            <label for="editProductPrice">Price (USD)</label>
                            <input type="number" id="editProductPrice" class="form-control" step="0.01" min="0" required>
                        </div>
                        <div class="form-group">
                            <label for="editProductImage">Image URL</label>
                            <input type="url" id="editProductImage" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="editProductCategory">Category</label>
                            <input type="text" id="editProductCategory" class="form-control">
                        </div>
                        <div class="form-group">
                            <label for="editProductFeatures">Features (comma separated)</label>
                            <input type="text" id="editProductFeatures" class="form-control">
                        </div>
                        <div class="form-group">
                            <label for="editProductUrl">Product Page URL</label>
                            <input type="url" id="editProductUrl" class="form-control" required>
                            <small style="color: #666; font-size: 12px;">External link for Buy button</small>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-save"></i> Save Changes
                            </button>
                            <button type="button" class="btn btn-outline" onclick="closeEditModal()">
                                <i class="fas fa-times"></i> Cancel
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Settings Section -->
            <div id="settingsSection" class="admin-section">
                <h2>Store Settings</h2>
                
                <div class="settings-group">
                    <h3>Checkout Settings</h3>
                    <div class="form-group">
                        <label for="checkoutUrl">Checkout URL</label>
                        <input type="url" id="checkoutUrl" class="form-control" placeholder="https://docs.google.com/forms/d/e/your-form-url/viewform">
                        <small>This is the URL where customers will be redirected when they click "Proceed to Checkout"</small>
                    </div>
                    <button class="btn btn-primary" onclick="saveCheckoutUrl()">
                        <i class="fas fa-save"></i> Save Checkout URL
                    </button>
                </div>

                <div class="settings-group">
                    <h3>Store Information</h3>
                    <div class="form-group">
                        <label for="storeName">Store Name</label>
                        <input type="text" id="storeName" class="form-control" value="GameZone">
                    </div>
                    <div class="form-group">
                        <label for="storeEmail">Contact Email</label>
                        <input type="email" id="storeEmail" class="form-control" value="info@gamezone.com">
                    </div>
                    <button class="btn btn-primary">
                        <i class="fas fa-save"></i> Save Store Info
                    </button>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer>
            <div class="container">
                <div class="copyright">
                    &copy; 2023 GameZone. All rights reserved.
                </div>
                <div class="powered-by">
                    Powered by MGP Studio
                </div>
            </div>
        </footer>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-storage-compat.js"></script>
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDDTdQRntlL10WMPBEbb5_9jp0Kc89fX8Y",
            authDomain: "legendlfestyle.firebaseapp.com",
            databaseURL: "https://legendlfestyle-default-rtdb.firebaseio.com",
            projectId: "legendlfestyle",
            storageBucket: "legendlfestyle.firebasestorage.app",
            messagingSenderId: "1078539571802",
            appId: "1:1078539571802:web:3ff1d6197ad72f94d73e63",
            measurementId: "G-WMEWTT1HR7"
        };

        // Initialize Firebase
        try {
            firebase.initializeApp(firebaseConfig);
            console.log("Firebase initialized successfully");
        } catch (error) {
            console.error("Firebase initialization error:", error);
        }
        
        const database = firebase.database();
        const storage = firebase.storage();

        // Admin credentials
        const ADMIN_EMAIL = "elitegamer859650@gmail.com";
        const ADMIN_PASSWORD = "acer4321234@";

        // Currency configuration
        const currencyRates = {
            'USD': { symbol: '$', rate: 1 },
            'EUR': { symbol: '€', rate: 0.85 },
            'GBP': { symbol: '£', rate: 0.73 },
            'INR': { symbol: '₹', rate: 74.5 },
            'JPY': { symbol: '¥', rate: 110 }
        };

        // Get selected currency from localStorage or default to USD
        let currentCurrency = localStorage.getItem('selectedCurrency') || 'USD';
        let currencySymbol = currencyRates[currentCurrency].symbol;
        let conversionRate = currencyRates[currentCurrency].rate;
        
        // Variables for image upload
        let uploadedImages = [];

        // Check if user is already logged in
        function checkLogin() {
            const isLoggedIn = localStorage.getItem('adminLoggedIn');
            console.log("Checking login status:", isLoggedIn);
            
            if (isLoggedIn === 'true') {
                document.getElementById('loginForm').style.display = 'none';
                document.getElementById('adminPanel').style.display = 'block';
                document.getElementById('currencySelect').value = currentCurrency;
                
                // Load checkout URL from Firebase
                database.ref('settings/checkoutUrl').once('value').then(snapshot => {
                    if (snapshot.exists()) {
                        document.getElementById('checkoutUrl').value = snapshot.val();
                    }
                }).catch(error => {
                    console.error("Error loading checkout URL:", error);
                });
                
                loadProductsTable();
                loadOrdersTable();
            } else {
                console.log("User not logged in, showing login form");
            }
        }

        // Login function
        function login() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            console.log("Login attempt with:", email);
            
            // Simple validation
            if (!email || !password) {
                document.getElementById('loginError').textContent = "Please enter both email and password!";
                document.getElementById('loginError').style.display = 'block';
                return;
            }
            
            if (email === ADMIN_EMAIL && password === ADMIN_PASSWORD) {
                localStorage.setItem('adminLoggedIn', 'true');
                document.getElementById('loginForm').style.display = 'none';
                document.getElementById('adminPanel').style.display = 'block';
                document.getElementById('loginError').style.display = 'none';
                document.getElementById('currencySelect').value = currentCurrency;
                
                console.log("Login successful!");
                
                // Load checkout URL from Firebase
                database.ref('settings/checkoutUrl').once('value').then(snapshot => {
                    if (snapshot.exists()) {
                        document.getElementById('checkoutUrl').value = snapshot.val();
                    }
                }).catch(error => {
                    console.error("Error loading checkout URL:", error);
                });
                
                loadProductsTable();
                loadOrdersTable();
            } else {
                document.getElementById('loginError').textContent = "Invalid email or password!";
                document.getElementById('loginError').style.display = 'block';
                console.log("Login failed - invalid credentials");
            }
        }

        // Logout function
        function logout() {
            localStorage.setItem('adminLoggedIn', 'false');
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('adminPanel').style.display = 'none';
            document.getElementById('email').value = '';
            document.getElementById('password').value = '';
            document.getElementById('loginError').style.display = 'none';
        }

        // Update currency
        function updateCurrency(currency) {
            currentCurrency = currency;
            localStorage.setItem('selectedCurrency', currency);
            currencySymbol = currencyRates[currency].symbol;
            conversionRate = currencyRates[currency].rate;
            
            // Reload tables to show updated prices
            if (document.getElementById('productsSection').classList.contains('active')) {
                loadProductsTable();
            } else if (document.getElementById('ordersSection').classList.contains('active')) {
                loadOrdersTable();
            }
        }

        // Show section function
        function showSection(sectionName) {
            // Hide all sections
            document.querySelectorAll('.admin-section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Remove active class from all nav buttons
            document.querySelectorAll('.admin-nav button').forEach(button => {
                button.classList.remove('active');
            });
            
            // Show selected section
            document.getElementById(sectionName + 'Section').classList.add('active');
            
            // Add active class to clicked button
            event.target.classList.add('active');
            
            // Load data if needed
            if (sectionName === 'products') {
                loadProductsTable();
            } else if (sectionName === 'orders') {
                loadOrdersTable();
            }
        }

        // Convert price based on selected currency
        function convertPrice(price) {
            return (price * conversionRate).toFixed(2);
        }

        // Load products table
        function loadProductsTable() {
            database.ref('products').once('value').then(snapshot => {
                const products = snapshot.val() || [];
                const productsTable = document.getElementById('productsTable');
                
                productsTable.innerHTML = '';
                
                if (products.length === 0) {
                    productsTable.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 20px;">No products found</td></tr>';
                    return;
                }
                
                products.forEach(product => {
                    const convertedPrice = convertPrice(product.price);
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${product.id}</td>
                        <td><img src="${product.image}" alt="${product.name}" style="width: 50px; height: 50px; object-fit: contain; background: #f8f9fa; padding: 5px; border-radius: 4px;"></td>
                        <td>${product.name}</td>
                        <td>${currencySymbol}${convertedPrice}</td>
                        <td>
                            ${product.productUrl ? 
                                `<a href="${product.productUrl}" target="_blank" style="color: var(--secondary); text-decoration: none; font-size: 12px;">
                                    <i class="fas fa-external-link-alt"></i> View URL
                                </a>` : 
                                '<span style="color: #999; font-size: 12px;">No URL</span>'
                            }
                        </td>
                        <td>
                            <button class="btn btn-warning" onclick="editProduct(${product.id})">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button class="btn btn-danger" onclick="deleteProduct(${product.id})">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </td>
                    `;
                    productsTable.appendChild(row);
                });
            }).catch(error => {
                console.error("Error loading products:", error);
                document.getElementById('productsTable').innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 20px; color: red;">Error loading products</td></tr>';
            });
        }

        // Edit product function
        function editProduct(productId) {
            database.ref('products').once('value').then(snapshot => {
                const products = snapshot.val() || [];
                const product = products.find(p => p.id === productId);
                
                if (product) {
                    document.getElementById('editProductId').value = product.id;
                    document.getElementById('editProductName').value = product.name;
                    document.getElementById('editProductDescription').value = product.description || '';
                    document.getElementById('editProductPrice').value = product.price;
                    document.getElementById('editProductImage').value = product.image || '';
                    document.getElementById('editProductCategory').value = product.category || '';
                    document.getElementById('editProductFeatures').value = (product.features || []).join(', ');
                    document.getElementById('editProductUrl').value = product.productUrl || '';
                    
                    document.getElementById('editProductModal').style.display = 'flex';
                }
            });
        }

        // Close edit modal
        function closeEditModal() {
            document.getElementById('editProductModal').style.display = 'none';
        }

        // Save edited product
        document.getElementById('editProductForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const productId = parseInt(document.getElementById('editProductId').value);
            const name = document.getElementById('editProductName').value;
            const description = document.getElementById('editProductDescription').value;
            const price = parseFloat(document.getElementById('editProductPrice').value);
            const image = document.getElementById('editProductImage').value;
            const category = document.getElementById('editProductCategory').value;
            const features = document.getElementById('editProductFeatures').value.split(',').map(f => f.trim());
            const productUrl = document.getElementById('editProductUrl').value;
            
            database.ref('products').once('value').then(snapshot => {
                let products = snapshot.val() || [];
                const productIndex = products.findIndex(p => p.id === productId);
                
                if (productIndex !== -1) {
                    products[productIndex] = {
                        ...products[productIndex],
                        name: name,
                        description: description,
                        price: price,
                        image: image,
                        category: category,
                        features: features,
                        productUrl: productUrl
                    };
                    
                    database.ref('products').set(products).then(() => {
                        loadProductsTable();
                        closeEditModal();
                        showAlert('Product updated successfully!', 'success');
                    }).catch(error => {
                        console.error("Error updating product:", error);
                        showAlert('Error updating product!', 'danger');
                    });
                }
            });
        });

        // Load orders table
        function loadOrdersTable() {
            database.ref('orders').once('value').then(snapshot => {
                const ordersData = snapshot.val();
                const orders = [];
                
                // Convert Firebase object to array
                if (ordersData) {
                    Object.keys(ordersData).forEach(key => {
                        orders.push({ ...ordersData[key], firebaseKey: key });
                    });
                }
                
                const ordersTable = document.getElementById('ordersTable');
                ordersTable.innerHTML = '';
                
                if (orders.length === 0) {
                    ordersTable.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 20px;">No orders found</td></tr>';
                    return;
                }
                
                orders.forEach(order => {
                    const orderCurrency = order.currency || 'USD';
                    const orderSymbol = currencyRates[orderCurrency].symbol;
                    const orderRate = currencyRates[orderCurrency].rate;
                    const convertedTotal = (order.total * orderRate).toFixed(2);
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${order.id}</td>
                        <td>${new Date(order.date).toLocaleDateString()}</td>
                        <td>${order.items ? order.items.length : 0} items</td>
                        <td>${orderSymbol}${convertedTotal}</td>
                        <td>
                            <select onchange="updateOrderStatus('${order.firebaseKey}', this.value)">
                                <option value="pending" ${order.status === 'pending' ? 'selected' : ''}>Pending</option>
                                <option value="processing" ${order.status === 'processing' ? 'selected' : ''}>Processing</option>
                                <option value="shipped" ${order.status === 'shipped' ? 'selected' : ''}>Shipped</option>
                                <option value="delivered" ${order.status === 'delivered' ? 'selected' : ''}>Delivered</option>
                                <option value="cancelled" ${order.status === 'cancelled' ? 'selected' : ''}>Cancelled</option>
                            </select>
                        </td>
                        <td>
                            <button class="btn btn-primary" onclick="viewOrderDetails('${order.firebaseKey}')">
                                <i class="fas fa-eye"></i> Details
                            </button>
                            <button class="btn btn-danger" onclick="deleteOrder('${order.firebaseKey}')">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </td>
                    `;
                    ordersTable.appendChild(row);
                });
            }).catch(error => {
                console.error("Error loading orders:", error);
                document.getElementById('ordersTable').innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 20px; color: red;">Error loading orders</td></tr>';
            });
        }

        // Add product function
        document.getElementById('addProductForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const name = document.getElementById('productName').value;
            const description = document.getElementById('productDescription').value;
            const price = parseFloat(document.getElementById('productPrice').value);
            const imageUrl = document.getElementById('productImage').value;
            const category = document.getElementById('productCategory').value;
            const features = document.getElementById('productFeatures').value.split(',').map(f => f.trim());
            const productUrl = document.getElementById('productUrl').value;
            
            // Determine which image to use (uploaded image or URL)
            let finalImageUrl = imageUrl;
            
            // If we have uploaded images, use the first one
            if (uploadedImages.length > 0) {
                finalImageUrl = uploadedImages[0];
            }
            
            // If no image provided, show error
            if (!finalImageUrl) {
                showAlert('Please provide an image for the product', 'danger');
                return;
            }
            
            // Validate product URL
            if (!productUrl) {
                showAlert('Please provide a product page URL for the Buy button', 'danger');
                return;
            }
            
            database.ref('products').once('value').then(snapshot => {
                const products = snapshot.val() || [];
                const newId = products.length > 0 ? Math.max(...products.map(p => p.id)) + 1 : 1;
                
                const newProduct = {
                    id: newId,
                    name: name,
                    description: description,
                    price: price,
                    image: finalImageUrl,
                    category: category,
                    features: features,
                    productUrl: productUrl
                };
                
                products.push(newProduct);
                database.ref('products').set(products).then(() => {
                    // Reset form
                    document.getElementById('addProductForm').reset();
                    document.getElementById('productCategory').value = "Gaming Accessories";
                    
                    // Clear uploaded images
                    uploadedImages = [];
                    document.getElementById('imagePreview').innerHTML = '';
                    
                    // Show success message
                    showAlert('Product added successfully!', 'success');
                    
                    // Switch to products section
                    showSection('products');
                }).catch(error => {
                    console.error("Error adding product:", error);
                    showAlert('Error adding product!', 'danger');
                });
            });
        });

        // Delete product function
        function deleteProduct(productId) {
            if (confirm('Are you sure you want to delete this product?')) {
                database.ref('products').once('value').then(snapshot => {
                    let products = snapshot.val() || [];
                    products = products.filter(product => product.id !== productId);
                    database.ref('products').set(products).then(() => {
                        loadProductsTable();
                        showAlert('Product deleted successfully!', 'success');
                    }).catch(error => {
                        console.error("Error deleting product:", error);
                        showAlert('Error deleting product!', 'danger');
                    });
                });
            }
        }

        // Update order status
        function updateOrderStatus(orderKey, newStatus) {
            database.ref('orders/' + orderKey).update({
                status: newStatus
            }).then(() => {
                showAlert('Order status updated!', 'success');
            }).catch(error => {
                console.error("Error updating order status:", error);
                showAlert('Error updating order status!', 'danger');
            });
        }

        // View order details
        function viewOrderDetails(orderKey) {
            database.ref('orders/' + orderKey).once('value').then(snapshot => {
                const order = snapshot.val();
                
                if (order) {
                    const orderCurrency = order.currency || 'USD';
                    const orderSymbol = currencyRates[orderCurrency].symbol;
                    const orderRate = currencyRates[orderCurrency].rate;
                    
                    let details = `Order ID: ${order.id}\nDate: ${new Date(order.date).toLocaleString()}\nStatus: ${order.status}\nCurrency: ${orderCurrency}\n\nItems:\n`;
                    
                    if (order.items && order.items.length > 0) {
                        order.items.forEach(item => {
                            const convertedPrice = (item.price * orderRate).toFixed(2);
                            details += `- ${item.name} (Qty: ${item.quantity}) - ${orderSymbol}${convertedPrice} each\n`;
                        });
                    } else {
                        details += "- No items\n";
                    }
                    
                    const convertedTotal = (order.total * orderRate).toFixed(2);
                    details += `\nTotal: ${orderSymbol}${convertedTotal}`;
                    
                    alert(details);
                }
            });
        }

        // Delete order
        function deleteOrder(orderKey) {
            if (confirm('Are you sure you want to delete this order?')) {
                database.ref('orders/' + orderKey).remove().then(() => {
                    loadOrdersTable();
                    showAlert('Order deleted successfully!', 'success');
                }).catch(error => {
                    console.error("Error deleting order:", error);
                    showAlert('Error deleting order!', 'danger');
                });
            }
        }

        // Save checkout URL
        function saveCheckoutUrl() {
            const url = document.getElementById('checkoutUrl').value;
            if (url) {
                database.ref('settings/checkoutUrl').set(url).then(() => {
                    showAlert('Checkout URL saved successfully!', 'success');
                }).catch(error => {
                    console.error("Error saving checkout URL:", error);
                    showAlert('Error saving checkout URL!', 'danger');
                });
            } else {
                showAlert('Please enter a valid URL', 'danger');
            }
        }

        // Show alert message
        function showAlert(message, type) {
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            alert.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 10000;';
            
            document.body.appendChild(alert);
            
            setTimeout(() => {
                alert.remove();
            }, 3000);
        }

        // Image Upload Functions
        function initializeImageUpload() {
            const imageUploadBox = document.getElementById('imageUploadBox');
            const imageFileInput = document.getElementById('imageFileInput');
            
            // Handle drag and drop
            imageUploadBox.addEventListener('dragover', function(e) {
                e.preventDefault();
                this.style.borderColor = 'var(--secondary)';
                this.style.backgroundColor = '#e3f2fd';
            });
            
            imageUploadBox.addEventListener('dragleave', function(e) {
                e.preventDefault();
                this.style.borderColor = '#ddd';
                this.style.backgroundColor = '#f8f9fa';
            });
            
            imageUploadBox.addEventListener('drop', function(e) {
                e.preventDefault();
                this.style.borderColor = '#ddd';
                this.style.backgroundColor = '#f8f9fa';
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleImageUpload(files[0]);
                }
            });
            
            // Handle file input change
            imageFileInput.addEventListener('change', function(e) {
                if (this.files.length > 0) {
                    handleImageUpload(this.files[0]);
                }
            });
        }
        
        // Handle image upload
        function handleImageUpload(file) {
            console.log("Starting image upload...", file);
            
            // Check if file is an image
            if (!file.type.match('image.*')) {
                showAlert('Please select an image file (JPEG, PNG, GIF)', 'danger');
                return;
            }
            
            // Check file size (max 5MB)
            if (file.size > 5 * 1024 * 1024) {
                showAlert('Image size should be less than 5MB', 'danger');
                return;
            }
            
            // Show uploading message and progress bar
            showAlert('Uploading image...', 'success');
            const progressBar = document.getElementById('uploadProgress');
            const progressBarInner = document.getElementById('uploadProgressBar');
            progressBar.style.display = 'block';
            progressBarInner.style.width = '0%';
            
            try {
                // Create a reference to the storage location
                const storageRef = storage.ref();
                const fileName = 'product-images/' + Date.now() + '-' + file.name.replace(/[^a-zA-Z0-9.]/g, '_');
                const imageRef = storageRef.child(fileName);
                
                console.log("Uploading to:", fileName);
                
                // Upload the file
                const uploadTask = imageRef.put(file);
                
                uploadTask.on('state_changed',
                    function(snapshot) {
                        // Progress monitoring
                        const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                        console.log('Upload is ' + progress + '% done');
                        progressBarInner.style.width = progress + '%';
                    },
                    function(error) {
                        console.error("Upload error:", error);
                        progressBar.style.display = 'none';
                        showAlert('Error uploading image: ' + error.message, 'danger');
                    },
                    function() {
                        // Upload completed successfully
                        uploadTask.snapshot.ref.getDownloadURL().then(function(downloadURL) {
                            console.log("File available at:", downloadURL);
                            
                            // Add the image URL to our array
                            uploadedImages.push(downloadURL);
                            
                            // Update the preview
                            updateImagePreview();
                            
                            // Auto-fill the image URL field
                            document.getElementById('productImage').value = downloadURL;
                            
                            // Hide progress bar
                            progressBar.style.display = 'none';
                            
                            showAlert('Image uploaded successfully!', 'success');
                        }).catch(error => {
                            console.error("Error getting download URL:", error);
                            progressBar.style.display = 'none';
                            showAlert('Error getting image URL!', 'danger');
                        });
                    }
                );
            } catch (error) {
                console.error("Upload exception:", error);
                progressBar.style.display = 'none';
                showAlert('Error uploading image!', 'danger');
            }
        }
        
        // Update image preview
        function updateImagePreview() {
            const imagePreview = document.getElementById('imagePreview');
            imagePreview.innerHTML = '';
            
            uploadedImages.forEach((imageUrl, index) => {
                const previewItem = document.createElement('div');
                previewItem.className = 'image-preview-item';
                
                previewItem.innerHTML = `
                    <img src="${imageUrl}" alt="Preview">
                    <button type="button" class="remove-btn" onclick="removeImage(${index})">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                
                imagePreview.appendChild(previewItem);
            });
        }
        
        // Remove image from preview and array
        function removeImage(index) {
            uploadedImages.splice(index, 1);
            updateImagePreview();
            // Clear the image URL field if no images left
            if (uploadedImages.length === 0) {
                document.getElementById('productImage').value = '';
            }
        }

        // Show image URL input
        function showImageUrlInput() {
            document.getElementById('imageUrlInput').style.display = 'block';
            document.getElementById('imageUploadBox').style.display = 'none';
            document.getElementById('productImage').value = '';
            uploadedImages = [];
            updateImagePreview();
        }

        // Show image upload box
        function showImageUploadBox() {
            document.getElementById('imageUploadBox').style.display = 'block';
            document.getElementById('imageUrlInput').style.display = 'none';
            document.getElementById('productImage').value = '';
        }

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            console.log("DOM loaded, initializing admin panel...");
            checkLogin();
            initializeImageUpload();
            
            // Close modal when clicking outside
            document.getElementById('editProductModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeEditModal();
                }
            });
        });
    </script>
</body>
</html>
